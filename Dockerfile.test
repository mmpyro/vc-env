# Dockerfile.test — Ubuntu-based integration test environment for vc-env
# Build context: project root
# Usage: docker build -f Dockerfile.test -t vc-env-test .
#        docker run --rm vc-env-test

FROM ubuntu:22.04

# ── System dependencies ────────────────────────────────────────────────────────
ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y --no-install-recommends \
        ca-certificates \
        curl \
        git \
        bash \
        wget \
    && rm -rf /var/lib/apt/lists/*

# ── Go toolchain ───────────────────────────────────────────────────────────────
ARG GO_VERSION=1.24.4
RUN set -eux; \
    ARCH="$(dpkg --print-architecture)"; \
    case "$ARCH" in \
        amd64) GOARCH="amd64" ;; \
        arm64) GOARCH="arm64" ;; \
        *) echo "Unsupported architecture: $ARCH" && exit 1 ;; \
    esac; \
    curl -fsSL "https://go.dev/dl/go${GO_VERSION}.linux-${GOARCH}.tar.gz" \
        | tar -C /usr/local -xz

ENV PATH="/usr/local/go/bin:${PATH}"

# ── Project source ─────────────────────────────────────────────────────────────
WORKDIR /src
COPY . .

# ── Build vc-env binary ────────────────────────────────────────────────────────
RUN go build -ldflags "-X main.Version=0.1.0" -o /usr/local/bin/vc-env ./cmd/vc-env \
    && chmod +x /usr/local/bin/vc-env

# ── Runtime environment ────────────────────────────────────────────────────────
ENV HOME=/root
ENV VCENV_ROOT=/root/.vc-env

# Prepend shims directory so the vcluster shim is found after `vc-env init`
ENV PATH="/root/.vc-env/shims:/usr/local/bin:/usr/local/go/bin:/usr/bin:/bin"

# ── Entry point ────────────────────────────────────────────────────────────────
# The test script detects it is already inside the container because VCENV_ROOT
# is set, and proceeds directly to the integration test suite.
ENTRYPOINT ["/bin/bash", "/src/scripts/test-docker.sh"]
